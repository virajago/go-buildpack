#!/bin/bash
set -euo pipefail

BUILD_DIR=$1
CACHE_DIR=$2
DEPS_DIR=$3
DEPS_IDX=$4

export BUILDPACK_DIR=`dirname $(readlink -f ${BASH_SOURCE%/*})`

# Do this for setting up Oracle client
BIN_DIR=$(cd $(dirname $0); pwd)
ROOT_DIR=$(dirname $BIN_DIR)
build=$(cd "$1/" && pwd)
mkdir -p $BUILD_DIR/go_oracle
mkdir -p $BUILD_DIR/.profile.d
mkdir -p $BUILD_DIR/go_oracle/oracle_client
echo "oracle folders created"
echo $BUILD_DIR

#Copy and unzip files
cp $ROOT_DIR/custom/oracle_client/* $BUILD_DIR/go_oracle/oracle_client
cd $BUILD_DIR/go_oracle/oracle_client

echo "extracting"
tar -xvzf "oracle_includes.tar.gz"
tar -xvzf "oracle_libs.tar.gz"
echo "files extracted"
#Setup env vars for compilation
export LD_LIBRARY_PATH="${build}/go_oracle/oracle_client/oracle/12.1/client64/lib/"
echo $LD_LIBRARY_PATH
export PKG_CONFIG_PATH="${build}/go_oracle/oracle_client"
echo $PKG_CONFIG_PATH

#echo "prefix=${build}/go_oracle/oracle_client/oracle/12.1/client64" > ${build}/go_oracle/oracle_client/oci8.pc
#echo "includedir=${build}/go_oracle/oracle_client/oracle/12.1/client64" >> ${build}/go_oracle/oracle_client/oci8.pc
#echo "libdir=${build}/go_oracle/oracle_client/oracle/12.1/client64/lib" >> ${build}/go_oracle/oracle_client/oci8.pc
#echo "" >> ${build}/go_oracle/oracle_client/oci8.pc
#echo "Name: oci8" >> ${build}/go_oracle/oracle_client/oci8.pc
#echo "Description: Oracle Instant Client" >> ${build}/go_oracle/oracle_client/oci8.pc
#echo "Version: 12.1" >> ${build}/go_oracle/oracle_client/oci8.pc
#echo 'Cflags: -I${includedir}' >> ${build}/go_oracle/oracle_client/oci8.pc
#echo 'Libs: -L${libdir} -lclntsh' >> ${build}/go_oracle/oracle_client/oci8.pc

cp ${build}/go_oracle/oracle_client/oci8.pc ${build}/oci8.pc

#Setup oracle library path when the container starts
mkdir -p $build/.profile.d
#echo 'export LD_LIBRARY_PATH=/home/vcap/app/go_oracle/oracle_client/oracle/12.1/client64/lib/' > $build/.profile.d/setuporacle.sh
cp ${build}/go_oracle/oracle_client/setuporacle.sh ${build}/.profile.d/setuporacle.sh

$BUILDPACK_DIR/bin/finalize_orig $@
